#!/usr/bin/env bash

set -euo pipefail

.buildkite/scripts/bootstrap.sh

function wait_for_typecheck() {
    retries=${1:-15}
    status=$(buildkite-agent meta-data get "type_check_status" --default "pending")

    if [[ "$status" == "pending" ]]; then
        echo "Waiting for typecheck to complete"
        sleep 120
        wait_for_typecheck $((retries - 1))
    elif [[ "$status" == "success" ]]; then
        echo "Typecheck completed successfully, pushing changes"
    else
        echo "Typecheck failed"
        exit 1
    fi
}

echo "--- Build API Docs"
node --max-old-space-size=12000 scripts/build_api_docs

if [[ "${PUBLISH_API_DOCS_CHANGES:-}" == "true" ]]; then

  if [[ "${1:-}" == "--wait-for-typecheck" ]]; then
    echo "--- Wait for typecheck to complete"
    wait_for_typecheck
  fi

  echo "--- Publish API Docs"

  git config --global user.name kibanamachine
  git config --global user.email '42973632+kibanamachine@users.noreply.github.com'

  branch="api_docs_$(date +%F_%H-%M-%S)"
  git checkout -b "$branch"
  git add ./*.docnav.json
  git add api_docs
  git commit -m "[api-docs] Daily api_docs build"

  git push origin "$branch"

  prUrl=$(gh pr create --repo elastic/kibana --base main --head "$branch" --title "[api-docs] $(date +%F) Daily api_docs build" --body "Generated by $BUILDKITE_BUILD_URL" --label "release_note:skip" --label "docs")
  echo "Opened PR: $prUrl"
  gh pr merge --repo elastic/kibana --auto --squash "$prUrl"

  GH_TOKEN="$KIBANA_CI_GITHUB_TOKEN" gh pr review --repo elastic/kibana --approve -b "Automated review from $BUILDKITE_BUILD_URL" "$prUrl"
fi
